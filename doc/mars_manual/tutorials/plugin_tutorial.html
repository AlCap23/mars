<!-- DO NOT EDIT THIS FILE! IT IS AUTOMATICALLY GENERATED BY markdown2marshtml //-->
             <!DOCTYPE html>
             <html>
               <head>
                 <title>MARS Simulator</title>
                 <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
                 <meta name="description" content="MARS is a flexible physics simulator.">
                 <meta name="author" content="MARS Project">
                 <meta name="keywords" content="MARS, simulation, physics, robotics">
                 <link rel="stylesheet" type="text/css" href="../../src/css/mars_default.css" media="all" />
               </head>
             <body>
               <div class="nav-box">
                 <h2>Navigation</h2>
                 <nav>
                   <ol>
                     <li><a href="../../mars_manual/index.html">Home</a></li>
                     <li>Common</li>
<ul>
  <li><a href="../../mars_manual/common/data_broker/data_broker.html">Data Broker</a></li>
    <li><a href="../../mars_manual/common/lib_manager/lib_manager.html">Lib Manager</a></li>
</ul>
    <li><a href="../../mars_manual/libraries.html">Libraries</a></li>
<li><a href="../../mars_manual/inner_workings.html">Inner Workings</a></li>
<li><a href="../../mars_manual/mars_scenes.html">Mars Scenes</a></li>
<li><a href="../../mars_manual/documentation_structure.html">Documentation Structure</a></li>
<li><a href="../../mars_manual/installation.html">Installation</a></li>
<li>Tutorials</li>
<ul>
  <li><a href="../../mars_manual/tutorials/plugin_tutorial.html">Plugin Tutorial</a></li>
<ul>
  <li><a href=#introduction>Introduction</a></li>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#basic-plugin>Basic Plugin</a></li>
<ul>
  <li><a href=#create-and-build-a-new-plugin>Create And Build A New Plugin</a></li>
<li><a href=#adapt-the-plugin>Adapt The Plugin</a></li>
</ul>
</ul>
  <li><a href="../../mars_manual/tutorials/building_mars.html">Building Mars</a></li>
  <li><a href="../../mars_manual/tutorials/advanced_modeling.html">Advanced Modeling</a></li>
  <li><a href="../../mars_manual/tutorials/basic_modeling.html">Basic Modeling</a></li>
</ul>

                   </ol>
                 </nav>
               </div>
               <div id="content">
               <header>
                 <a href="../../mars_manual/index.html"><img src="../../src/images/logo_v2_wob.png" alt="MARS" /></a>
               </header>
<h1 id="tutorial_basic_plugin">Basic Plugin</h1>
<div class="figure">
<img width="800" height="463" src="../../src/images/robo.jpg" />
</div>
<h2 id="introduction">Introduction</h2>
<p>There are different possibilities how the MARS simulation can be used. One possibility is to write a plugin that handles the loading of a scenario and interfaces the simulation to some control software. Also, in many cases, the control software can be directly wrapped into a simulation plugin. This tutorial will guide you how to create a new plugin, load your scene, and control the simulation.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>We assume you already have a MARS development environment setup in &quot;<span class="math">$MARS_DEV_ROOT&quot;.  You should also have a robot scene file to start with (if not you can use this `scene &lt;robo.scn&gt;`_ to follow the tutorial.  You should have a terminal opened with the $</span>MARS_DEV_ROOT/env.sh sourced into it.</p>
<pre><code>cd $MARS_DEV_ROOT;
. env.sh</code></pre>
<h2 id="basic-plugin">Basic Plugin</h2>
<h3 id="create-and-build-a-new-plugin">Create and build a new plugin</h3>
<p>To setup your first plugin you can use a script wich will create a new plugin:</p>
<pre><code>cd $MARS_DEV_ROOT/mars/plugins/plugin_template
./cnp.sh</code></pre>
<p>The script will ask you for the project name, from which it will also try to derive the class name of the main c++ class. E.g. we can enter &quot;basic_plugin&quot; here and the main class will then be called &quot;BasicPlugin&quot;. Then you can enter a description of your plugin (&quot;The plugin created by following the guide of the basic plugin tutorial.&quot;). Afterwards, enter the author name, email, and confirm your data. The script will create a folder containing your plugin one directory above the script location (&quot;$MARS_DEV_ROOT/mars/plugins/basic_plugin&quot;). You can go into that folder and use the build.sh script to build the plugin for a first test if everything went well. To install the plugin you have to use &quot;make install&quot; within the newly created build folder.</p>
<pre><code>cd $MARS_DEV_ROOT/mars/plugins/basic_plugin
./build.sh
cd build
make install</code></pre>
<p>Now copy the &quot;mars_default&quot; configuration to &quot;mars_basic_plugin&quot; and add the plugin to the &quot;other_libs.txt&quot; within &quot;mars_basic_plugin&quot; to load the new plugin when starting MARS.</p>
<pre><code>cd $MARS_DEV_ROOT/install/configuration
cp -r mars_default mars_basic_plugin
cd mars_basic_plugin</code></pre>
<p>Content of other_libs.txt:</p>
<pre><code>log_console
connexion_plugin
data_broker_gui
cfg_manager_gui
lib_manager_gui
basic_plugin</code></pre>
<p>Start the simulation:</p>
<pre><code>mars_app</code></pre>
<p>Currently the plugin does not do anything, but it should show up in the list of loaded plugins which you can find under the menu entry: File-&gt;Library Info...</p>
<h3 id="adapt-the-plugin">Adapt the plugin</h3>
<p>In the &quot;$MARS_DEV_ROOT/mars/plugins/basic_plugin/src/BasicPlugin.cpp&quot; you will find a &quot;init()&quot; function that is called by the simulation to initialize the plugin. If your initialization code depends on the simulation or other plugins you should rather perform it in the init() function than in the constructor as the other modules may not be in a defined state, yet. Just comment in the loadScene line with the path to your scene file.</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> BasicPlugin::init() {
    <span class="co">// Load a scene file:</span>
    control-&gt;sim-&gt;loadScene(<span class="st">&quot;robo.scn&quot;</span>);</code></pre>
<p>In this tutorial we are going to access the motors and sensors of the simulation. To do that we first need to include the corresponding interfaces:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#include &lt;mars/interfaces/sim/MotorManagerInterface.h&gt;</span>
<span class="ot">#include &lt;mars/interfaces/sim/SensorManagerInterface.h&gt;</span></code></pre>
<p>To control the robot in the simulation you can set motor values in the update callback. The update callback is triggered by the simulation thread giving the simulation step time as parameter. Here we can set some motor values:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> BasicPlugin::update(sReal time_ms) {

    control-&gt;motors-&gt;setMotorValue(<span class="dv">1</span>, <span class="fl">1.0</span>);
    control-&gt;motors-&gt;setMotorValue(<span class="dv">2</span>, <span class="fl">3.0</span>);
}</code></pre>
<p>After doing &quot;make install&quot; in &quot;$MARS_DEV_ROOT/mars/plugins/basic_plugin/build&quot; we should have a small robot driving in circles when we start the simulation.</p>
<p>In the next step we want to read the sensor values from the laser scanner to create a wall following behavior. We can access the sensor values by the id the sensor gets when it is loaded into the simulation:</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> BasicPlugin::update(sReal time_ms) {
    <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> laserId = control-&gt;sensors-&gt;getSensorID(<span class="st">&quot;laser&quot;</span>);

    control-&gt;motors-&gt;setMotorValue(<span class="dv">1</span>, <span class="fl">1.0</span>);
    control-&gt;motors-&gt;setMotorValue(<span class="dv">2</span>, <span class="fl">3.0</span>);
}</code></pre>
<p>The &quot;getSensorData()&quot; methods takes the sensor id and a pointer to a unallocated sReal pointer as arguments. It will allocate memory for the sensor data but the caller (in this case that is you) is responsible for freeing the memory after reading the sensor data. The method returns the number of values representing the sensor data.</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="dt">void</span> BasicPlugin::update(sReal time_ms) {
    <span class="dt">static</span> <span class="dt">unsigned</span> <span class="dt">long</span> laserId = control-&gt;sensors-&gt;getSensorID(<span class="st">&quot;laser&quot;</span>);
    sReal *sensorData;
    <span class="dt">int</span> numSensorValues = control-&gt;sensors-&gt;getSensorData(laserId, &amp;sensorData);
    assert(numSensorValues == <span class="dv">8</span>);
    <span class="kw">if</span>(sensorData[<span class="dv">3</span>] &lt; <span class="fl">1.0</span> || sensorData[<span class="dv">0</span>] &lt; <span class="fl">0.4</span>) {
      control-&gt;motors-&gt;setMotorValue(<span class="dv">2</span>, <span class="fl">12.0</span>);
    } <span class="kw">else</span> <span class="kw">if</span>(sensorData[<span class="dv">0</span>] &gt; <span class="fl">0.7</span>) {
      control-&gt;motors-&gt;setMotorValue(<span class="dv">2</span>, <span class="fl">4.8</span>);
    } <span class="kw">else</span> {
      control-&gt;motors-&gt;setMotorValue(<span class="dv">2</span>, <span class="fl">5.0</span>);
    }
    control-&gt;motors-&gt;setMotorValue(<span class="dv">1</span>, <span class="fl">5.0</span>);
    free(sensorData);
}</code></pre>
<p>Now we can do &quot;make install&quot; again, start the simulation, and we should see the robot following the wall!</p>
<p>The plugin source generated by the &quot;cnp.sh&quot; script includes many commented code, that gives examples of how to use the simulation modules like the &quot;DataBroker&quot;, the &quot;CFGManager&quot;, or the &quot;MainGUI&quot;. A seperated documentation of these modules will be created soon.</p>

      <footer>
        <a href="http://validator.w3.org/check?uri=referer" target="_blank">
          <img src="http://www.w3.org/Icons/valid-html401"
               alt="Valid HTML 4.01 Transitional"/>
        </a>
        <a href="http://jigsaw.w3.org/css-validator/check/referer" target="_blank">
          <img src="http://jigsaw.w3.org/css-validator/images/vcss"
               alt="Valid CSS!"/>
        </a>
      </footer>
    </div>
  </body>
</html>
