<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>MARS: Basic Plugin</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../mars_doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../logo_v2_wob.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">MARS
   </div>
   <div id="projectbrief">An open-source, flexible 3D physical simulation framework</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d8/dd8/tutorial_basic_plugin.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Basic Plugin </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="../../../images/tutorials/plugin/robo.jpg" />
</div>
<h2>Introduction</h2>
<p>There are different possibilities how the MARS simulation can be used. One possibility is to write a plugin that handles the loading of a scenario and interfaces the simulation to some control software. Also, in many cases, the control software can be directly wrapped into a simulation plugin. This tutorial will guide you how to create a new plugin, load your scene, and control the simulation.</p>
<h2>Prerequisites</h2>
<p>We assume you already have a MARS development environment setup in "$MARS_DEV_ROOT". You should also have a simulation scene or SMURF file to load into the simulation. Open a terminal and source your environment: </p>
<pre class="fragment">cd $MARS_DEV_ROOT;
. env.sh
</pre><h2>Basic Plugin</h2>
<h3>Create and build a new plugin</h3>
<p>To setup your first plugin you can use a script wich will create a new plugin: </p>
<pre class="fragment">cd simulation/mars/plugins/plugin_template
./cnp.sh
</pre><p>The script will ask you for the project name, from which it will also try to derive the class name of the main c++ class.</p>
<blockquote class="doxtable">
<p>NOTE: In project names, be sure to avoid special</p>
<p></p>
</blockquote>
<p>characters such as **"**, **&amp;** and so on. They may cause problems in the subsequently executed scripts or the file system, as the name entered is used to create variables and file/folder names. Dashes ( **-** ) and underscores ( **_** ) are fine.</p>
<p>E.g. we can enter "basic_plugin" here and the main class will then be called "BasicPlugin". Then you can enter a description of your plugin ("The
plugin created by following the guide of the basic plugin tutorial."). Afterwards, enter the author name, email, and confirm your data. The script will create a folder containing your plugin one directory above the script location ("$MARS_DEV_ROOT/mars/plugins/basic_plugin"). You can go into that folder and use the build.sh script to build the plugin for a first test if everything went well. To install the plugin you have to use "make install" within the newly created build folder. </p>
<pre class="fragment">cd $MARS_DEV_ROOT/mars/plugins/basic_plugin
./build.sh
cd build
make install
</pre><p>If you want to create a custom configuration to work with your plugin, copy the "mars_default" configuration to "mars_basic_plugin", rename your example additional lib configuration file "other_libs.txt.example" into "other_libs.txt" and add your plugin to the list in the file. This will cause your plugin to be loaded upon startup of MARS. </p>
<pre class="fragment">cd $MARS_DEV_ROOT/install/configuration
cp -r mars_default mars_basic_plugin
cd mars_basic_plugin
</pre><p>Content of other_libs.txt: </p>
<pre class="fragment">...
connexion_plugin
data_broker_gui
cfg_manager_gui
lib_manager_gui
basic_plugin
</pre><p>Start the simulation: </p>
<pre class="fragment">mars_app
</pre><p>Currently the plugin does not do anything, but it should show up in the list of loaded plugins which you can find under the menu entry: File-&gt;Library Info...</p>
<h3>Adapt the plugin</h3>
<p>In the "$MARS_DEV_ROOT/mars/plugins/basic_plugin/src/BasicPlugin.cpp" you will find a "init()" function that is called by the simulation to initialize the plugin. If your initialization code depends on the simulation or other plugins you should rather perform it in the init() function than in the constructor as the other modules may not be in a defined state, yet. Just comment in the loadScene line with the path to your scene file.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> BasicPlugin::init() {</div>
<div class="line">    <span class="comment">// Load a scene file:</span></div>
<div class="line">    control-&gt;sim-&gt;loadScene(<span class="stringliteral">&quot;robo.scn&quot;</span>);</div>
</div><!-- fragment --><p>In this tutorial we are going to access the motors and sensors of the simulation. To do that we first need to include the corresponding interfaces:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;mars/interfaces/sim/MotorManagerInterface.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;mars/interfaces/sim/SensorManagerInterface.h&gt;</span></div>
</div><!-- fragment --><p>To control the robot in the simulation you can set motor values in the update callback. The update callback is triggered by the simulation thread giving the simulation step time as parameter. Here we can set some motor values:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> BasicPlugin::update(<a class="code" href="../../d8/dec/namespacemars_1_1interfaces.html#a0214a0e5003a1d8362b66e3fda378b2e">sReal</a> time_ms) {</div>
<div class="line"></div>
<div class="line">    control-&gt;motors-&gt;setMotorValue(1, 1.0);</div>
<div class="line">    control-&gt;motors-&gt;setMotorValue(2, 3.0);</div>
<div class="line">}</div>
</div><!-- fragment --><p>After doing "make install" in "$MARS_DEV_ROOT/mars/plugins/basic_plugin/build" we should have a small robot driving in circles when we start the simulation.</p>
<p>In the next step we want to read the sensor values from the laser scanner to create a wall following behavior. We can access the sensor values by the id the sensor gets when it is loaded into the simulation:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> BasicPlugin::update(<a class="code" href="../../d8/dec/namespacemars_1_1interfaces.html#a0214a0e5003a1d8362b66e3fda378b2e">sReal</a> time_ms) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> laserId = control-&gt;sensors-&gt;getSensorID(<span class="stringliteral">&quot;laser&quot;</span>);</div>
<div class="line"></div>
<div class="line">    control-&gt;motors-&gt;setMotorValue(1, 1.0);</div>
<div class="line">    control-&gt;motors-&gt;setMotorValue(2, 3.0);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The "getSensorData()" methods takes the sensor id and a pointer to a unallocated sReal pointer as arguments. It will allocate memory for the sensor data but the caller (in this case that is you) is responsible for freeing the memory after reading the sensor data. The method returns the number of values representing the sensor data.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> BasicPlugin::update(<a class="code" href="../../d8/dec/namespacemars_1_1interfaces.html#a0214a0e5003a1d8362b66e3fda378b2e">sReal</a> time_ms) {</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> laserId = control-&gt;sensors-&gt;getSensorID(<span class="stringliteral">&quot;laser&quot;</span>);</div>
<div class="line">    <a class="code" href="../../d8/dec/namespacemars_1_1interfaces.html#a0214a0e5003a1d8362b66e3fda378b2e">sReal</a> *sensorData;</div>
<div class="line">    <span class="keywordtype">int</span> numSensorValues = control-&gt;sensors-&gt;getSensorData(laserId, &amp;sensorData);</div>
<div class="line">    assert(numSensorValues == 8);</div>
<div class="line">    <span class="keywordflow">if</span>(sensorData[3] &lt; 1.0 || sensorData[0] &lt; 0.4) {</div>
<div class="line">      control-&gt;motors-&gt;setMotorValue(2, 12.0);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(sensorData[0] &gt; 0.7) {</div>
<div class="line">      control-&gt;motors-&gt;setMotorValue(2, 4.8);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      control-&gt;motors-&gt;setMotorValue(2, 5.0);</div>
<div class="line">    }</div>
<div class="line">    control-&gt;motors-&gt;setMotorValue(1, 5.0);</div>
<div class="line">    free(sensorData);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now we can do "make install" again, start the simulation, and we should see the robot following the wall!</p>
<p>The plugin source generated by the "cnp.sh" script includes many commented code, that gives examples of how to use the simulation modules like the "DataBroker", the "CFGManager", or the "MainGUI". A seperated documentation of these modules will be created soon. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Mar 2 2015 17:29:44 for MARS by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.5 </li>
  </ul>
</div>
</body>
</html>
